<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<title>Cartagen</title>
	<link rel="stylesheet" href="../cartagen/style.css" type="text/css" media="screen" title="no title" charset="utf-8">
	<!--[if IE]><script type="text/javascript" src="../cartagen/excanvas.js"></script><![endif]-->
	<script src="../cartagen/cartagen.js" type="text/javascript" charset="utf-8"></script>
	<meta name="viewport" content="width=320; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
	<script type="text/javascript" charset="utf-8">
		Cartagen.setup({
			stylesheet: "../static/rome/style.gss",
			static_map: true,
			static_map_layers: ["map.json"],
			lat: 42.360140177156026, 
			lng: -71.08812053061226,
			zoom_level: 1.0749999999999986
		})
		
		// Tool.active == 'Warp'
		
		var shapes = []
		
		function new_shape() {
			Tool.change("Pen")
			Tool.Pen.mode='draw'
			shapes.push(new PointShape([]))
		}
		
		var PointShape = Class.create({
			initialize: function(nodes) {
				this.active = false
				this.points = $A()
				this.diddit = false
				Glop.observe('glop:postdraw', this.draw.bindAsEventListener(this))
				Glop.observe('mousedown', this.click.bindAsEventListener(this))
				nodes.each(function(node) {
					this.points.push(new DraggablePoint(node[0], node[1], 20, this))
				}, this)
				// remember that nodes is no longer updated!!!
			},
			new_point: function(x,y) {
				this.points.push(new DraggablePoint(x, y, 20, this))
			},
			draw: function() {
				if (!this.diddit) {
					this.diddit=true
					var ps = ''
					this.points.each(function(point) {
						ps += '(' + point.x + ',' + point.y + ')'
					})
					//alert(ps)
				}
				$C.save()
				$C.stroke_style('#000')
				$C.fill_style('#222')
				if (this.active) $C.line_width(2)
				else $C.line_width(0)
				$C.begin_path()
				if (this.points.length>0){
					$C.move_to(this.points[0].x, this.points[0].y)		
					this.points.each(function(point) {
						$C.line_to(point.x, point.y)
					})			
					$C.line_to(this.points[0].x, this.points[0].y)
					
				}
			

				$C.opacity(0.4)
				$C.stroke()
				$C.opacity(0.2)
				$C.fill()
				$C.restore()
			},
			click: function() {
				if (Geometry.is_point_in_poly(this.points, Map.pointer_x(), Map.pointer_y())&&Tool.active!='Pen') {
					this.active = true
					Tool.change('Warp')
				} else if (Tool.active!='Pen') {
					this.active = false
				}
			}
		})
		
		var DraggablePoint = Class.create({
			initialize: function(x,y,r,parent) {
				this.x = x
				this.y = y
				this.r = r
				this.parent_shape = parent
				this.color = '#200'
				this.dragging = false
				Glop.observe('glop:postdraw', this.draw.bindAsEventListener(this))
				Glop.observe('mousedown', this.click.bindAsEventListener(this))
			},
			// this gets called every frame:
			draw: function() {
				// transform to 1:1 scale pixelwise (the map is not at this scale by default)
				// first, save the transformation matrix:
				if (this.parent_shape.active) {
					$C.save()
				
						// go to the object's location:
						$C.translate(this.x,this.y)
							// draw the object:
							$C.fill_style(this.color)
							$C.opacity(0.6)
							$C.rect(-this.r/2,-this.r/2,this.r,this.r)
					$C.restore()
				}
				
				/*var nodestring = ''
				nodes.each(function(node) {
					nodestring += '(' + node[0] + ', ' + node[1] + ')\n'
				})*/
				
				if (this.dragging && Mouse.down) {
					this.drag()
				} else if (this.mouse_inside()) {
					if (Mouse.down) {
						this.drag()
					} else {
						this.hover()
					}
				} else {
					this.base()
				}
			},
			mouse_inside: function() {
				return (Geometry.distance(this.x, this.y, Map.pointer_x(), Map.pointer_y()) < this.r)
			},
			base: function() {
				// do stuff
				this.color = '#200'
				this.dragging = false
			},
			click: function() {
				if (Geometry.distance(this.x, this.y, Map.pointer_x(), Map.pointer_y()) < this.r  && Tool.active!='Pen') {
					this.color = '#f00'
					// do stuff
					console.log('clicked control point')
					this.parent_shape.active = true
					Tool.change('Warp')
				}
			},
			hover: function() {
				// do stuff
				this.color = '#900'
				this.dragging = false
			},
			drag: function() {
				if (this.parent_shape.active) {
					// do stuff
					if (!this.dragging) {
						this.dragging = true
						this.drag_offset_x = Map.pointer_x() - this.x
						this.drag_offset_y = Map.pointer_y() - this.y
					}
					this.color = '#f00'
					this.x = Map.pointer_x() - this.drag_offset_x
					this.y = Map.pointer_y() - this.drag_offset_y
				}
			},
			r: function() {
				// do stuff
				this.color = '#00f'
			}
		})
		
		function debug(data) {
			data.each(function(pair) {
				$(pair.key).update(pair.value)
			})
		}

		function setup() {

		}
		document.observe('cartagen:init', setup)
		
	</script>
	
	<style>
	#debug {
		background-color: rgba(255,255,255,0.7);
		position: absolute;
		top: 0; right: 0;
		padding: 10px;
	}
	.hidden { display: none; }
	span {
		width: 250px;
		text-align: right;
		text-decoration: underline;
		display: block;
	}
	</style>
</head>
<body>

<div id="canvas"></div>
<div id="debug">
	<a href="javascript:void()" onClick="new_shape()">add a shape</a><br />
</div>

</body>
</html>
