<% if @export && @export.tms %>
<iframe id="preview" src="http://archive.publiclaboratory.org/leaflet/?tms=http://mapknitter.org/tms/<%= @map.name %>/&lon=<%= @map.lon %>&lat=<%= @map.lat %>&zoom=17"></iframe>
<% else %>
<p><i>This map has not been exported yet. <a href="http://publiclaboratory.org/wiki/mapknitter">Run an export</a> to generate an embeddable and browseable preview.</i></p>
<% end %>

<br style="clear:left;" />

<div id="main">
	<h2><%= @map.name %></h2>	
	<p><small>by <a href="/author/<%= @map.author %>"><%= @map.author %></a>
	<% if admin && @map.email != '' %><<a href="mailto:<%= @map.email %>"><%= @map.email %></a>>,</a><% end %></small></p>

	<h3><a style="text-decoration:underline" href="/maps/<%= @map.name %>">Edit map &raquo;</a></h3>

	<% if @images.length > 0 %><h2>Images in this map:</h2><% end %>
	<div id='images'>
		<% @images.each do |image| %>
		<div class="image">
			<a href="<%= image.public_filename %>"><img src="<%= image.public_filename(:thumb) %>" /></a>
			<p>
			 <%= image.cm_per_pixel.to_s[0..2] %> cm/px<br /> 
			 <%= time_ago_in_words(image.created_at) %> ago
			</p>
		</div>
		<% end %>
		<br style="clear:left;" />
	</div>
	
	<h2 id="comments">Comments</h2>

	<p>No comments (feature in development)</p>

</div>

<div id="sidebar">


<% if @images.length > 0
	hist = @map.images_histogram 
	grouphist = @map.grouped_images_histogram((hist.length/15).to_i+1)
%>
	<p>0 cm/px <span class="bar"><%= grouphist.join(',') %></span> <%= hist.length-1 %> cm/px</p>
	<p>Average resolution: <%= @map.average_cm_per_pixel.to_s[0..2] %> cm/px</p>

<% end %>
	<script>
	$('.bar').sparkline('html', {type: 'bar'});
	</script>

<div class='box form'>
	<h3>Edit map details <small>(<a href="javascript:void(0);" onClick="$('#new_map').toggle()">Expand +</a>)</small></h3>
	<form style="display:none;" class='map' id="new_map" action="/map/update_map/<%= @map.name %>" method="get" accept-charset="utf-8">
	
		<input type='hidden' name='map[id]' value="<%= @map.id %>"/>
		
		<label for="location">Place</label><br />
		<input class="text" type="text" name="map[location]" value="<%= @map.location %>" id="new_map_place"><br />
		<% if admin %>
		<label for="password">Password (optional -- to keep your map private)</label><br />
		<input class="text" type="password" name="map[password]" value="<%= "*****" if @map.password != "" %>" id="new_map_password"><br />
		<% end %>
		<div id="geocode_results">
			
		</div>
		<script>
	    /* JQuery search as you type
	    * Overrides the action and method of the form
	    */
	      $(window).ready(function() {
	        $("#new_map_place").autocomplete("/map/geolocate",
	          { cacheLength:1, multiple:false, minchars:1, mustMatch:false,
	            highlight:false,
	            formatItem: function(x) {
	              return x[0];
	            },
	            formatResult: function(x) {
	              if(x[1]) {
	                //real object, with a url field
	                return x[0];
	              } else {
	                //a header, return null character
	                return "\0";
	              }
	            },
		    search: function(event,ui) {
		    }
	          });
	          $("#new_map_place").result(function(event, data, formatted) {
		    if (data == 'No results'){  
	            
		    } else {
	              $("#new_map_place").attr('value',data);
		    }
		  })
          	});
	    

		</script>
		<label for="author">Author</label><br />
		<input class="text" type="text" name="map[author]" value="<%= @map.author %>" id="author"><br />
		<p><%= recaptcha_tags :display => {:theme => "white"} %></p>
		<label for="description">Description</label><br />
		<textarea name="map[description]" rows="8" cols="24"><%= @map.description %></textarea><br />
		
		<!--<label for="password">Password (optional)</label><br />
		<input class="text" type="password" name="password" value="" id="password"><br />-->
			
		<% if @map.password != "" %>
		<label for="password">Password (you must enter the password to save)</label><br />
		<input class="text" type="password" name="password" id="password"><br />
		<% end %>
		<p><input type="submit" value="Save"></p>
	</form>
</div>

<div class='box'>
	<h3>Export formats</h3>

	<% if false # @export.tms %>
	<i>Embed code:</i><br />
	<textarea id="embedcode"><iframe style="border:0;" width="500px" height="375px" src="http://archive.publiclaboratory.org/leaflet/?tms=http://mapknitter.org/tms/<%= @map.name %>/&lon=<%= @map.lon %>&lat=<%= @map.lat %>&zoom=17"></iframe></textarea>
	<% end %>

	<% if @export %>
		<p>Available export formats:</p>
		<%= render :partial => "map/formats" %>
	<% else %>
		<p><i>This map has not been exported yet. <a href="http://publiclaboratory.org/wiki/mapknitter">Run an export</a> to generate an embeddable and browseable preview.</i></p>
	<% end %>

</div>
	
</div>

